<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wanakana/wanakana.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --duo-green: #58cc02;
      --duo-green-dark: #58a700;
      --duo-blue: #1cb0f6;
      --duo-blue-dark: #1899d6;
      --duo-red: #ea2b2b;
      --duo-red-dark: #c82424; /* Added for red button active state */
      --duo-yellow-light: rgba(254, 219, 0, 0.1);
      --duo-green-light: rgba(88, 204, 2, 0.15);
      --duo-blue-light: rgba(28, 176, 246, 0.1);
      --duo-gray-light: #f7f7f7;
      --duo-gray-border: #e5e5e5;
      --white: #ffffff;
      --dark-text: #4c4c4c;
    }
    body {
      font-family: 'Nunito', sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      color: var(--dark-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
      background-color: var(--duo-gray-light);
      background-image:
        radial-gradient(circle 50vmax at 10% 20%, var(--duo-green-light), transparent 50%),
        radial-gradient(circle 40vmax at 90% 85%, var(--duo-blue-light), transparent 50%),
        radial-gradient(circle 35vmax at 50% 50%, var(--duo-yellow-light), transparent 45%);
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    /* â–¼â–¼â–¼ [å¤‰æ›´] Duolingoé¢¨ã®é…è‰²ã«æˆ»ã—ã¾ã—ãŸ â–¼â–¼â–¼ */
    header {
      background: var(--duo-green);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--duo-gray-border);
      position: relative;
      z-index: 10;
      width: 100%;
      box-sizing: border-box;
    }
    #title {
      flex-grow: 1;
      text-align: center;
      font-size: 32px;
      font-weight: 900;
      font-style: italic;
      color: var(--white);
      text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
    }
    /* â–²â–²â–² â–²â–²â–² */
    #start-screen, .quiz-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 40px;
      background: var(--white);
      border-radius: 16px;
      border: 2px solid var(--duo-gray-border);
      opacity: 0;
    }
    .animate-in {
      animation: fadeInUp 0.5s 0.1s ease-out forwards;
    }
    .feedback-animate {
      animation: popIn 0.4s ease-out forwards;
    }
    #start-screen h1 {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #start-screen p {
      font-size: 18px;
      color: var(--dark-text);
      margin-bottom: 30px;
    }
    #username {
      padding: 12px 15px;
      font-size: 18px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      width: 300px;
      border: 2px solid var(--duo-gray-border);
      border-radius: 12px;
      display: block;
      margin: 0 auto 20px;
      transition: all 0.2s ease;
    }
    #username:focus {
      outline: none;
      border-color: var(--duo-blue);
    }
    .quiz-container {
      width: 100%;
      min-height: 550px;
      box-sizing: border-box;
    }
    .input-field {
      margin: 10px;
      padding: 10px 15px;
      font-size: 20px;
      font-weight: 700;
      width: 250px;
      border: 2px solid var(--duo-gray-border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--duo-blue);
    }
    .input-field:disabled {
      background-color: #f2f2f2;
      color: #999;
    }
    .button {
      position: relative;
      margin: 10px 5px;
      padding: 12px 24px;
      font-size: 18px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      border-radius: 16px;
      color: white;
      transition: top 0.1s ease, background 0.2s ease;
    }
    .button.btn-green {
      background: var(--duo-green);
      border-bottom: 4px solid var(--duo-green-dark);
    }
    .button.btn-blue {
      background: var(--duo-blue);
      border-bottom: 4px solid var(--duo-blue-dark);
    }
    .button.btn-red { /* Added for consistency */
      background: var(--duo-red);
      border-bottom: 4px solid var(--duo-red-dark);
    }
    .button:active {
      top: 2px;
      border-bottom-width: 2px;
    }
    .button:disabled {
      background: #ccc;
      border-bottom: 4px solid #999;
      cursor: not-allowed;
      top: 0;
    }
    .button:disabled:active {
      top: 0;
      border-bottom-width: 4px;
    }
    #header-buttons-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #header-buttons-container div { margin-bottom: 5px; }
    #header-buttons-container div:last-child { margin-bottom: 0; }
    #toggleHistoryBtn { display: none; }
    .circle-button {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      margin-left: 8px;
      font-size: 16px;
      border-bottom: 2px solid var(--duo-green-dark);
    }
    .circle-button:active {
      top: 1px;
      border-bottom-width: 1px;
    }
    .hidden { display: none; }
    #question {
      font-size: 28px;
      font-weight: 900;
      margin-bottom: 15px;
    }
    #question .jp-translation {
      font-size: 18px;
      color: var(--dark-text);
      margin-top: 8px;
      font-weight: 400;
    }
    #translation { font-size: 18px; margin-top: 20px; line-height: 1.6; }
    #input-wrapper {
      position: relative;
      min-height: 60px;
      margin: 20px 0;
    }
    #feedback {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(160px, -50%);
      width: 200px;
      text-align: left;
      font-size: 24px;
      font-weight: 900;
      opacity: 0;
    }
    #feedback.correct { color: var(--duo-green); }
    #feedback.incorrect { color: var(--duo-red); }
    .progress-bar {
      height: 20px;
      background-color: var(--duo-gray-border);
      border-radius: 10px;
      margin-top: 20px;
      overflow: hidden;
      padding: 4px;
    }
    .progress {
      height: 100%;
      width: 0%;
      background: var(--duo-green);
      border-radius: 8px;
      transition: width 0.4s ease-in-out;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.2);
    }
    #history-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 250px;
      overflow-y: auto;
      background-color: var(--white);
      border-top: 2px solid var(--duo-gray-border);
      padding: 10px;
      box-sizing: border-box;
      text-align: left;
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
      z-index: 100;
    }
    #history-container.show { transform: translateY(0); }
    #history-container h2 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 900;
    }
    #history-list { list-style: none; padding: 0; margin: 0; }
    #history-list li {
      background-color: var(--white);
      padding: 10px;
      border-bottom: 1px solid var(--duo-gray-border);
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #history-list li:hover { background-color: var(--duo-gray-light); }
    #clearHistoryBtn {
      font-size: 12px;
      padding: 4px 8px;
      background-color: var(--duo-red);
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 15px;
    }
    #historySearchInput {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #closeHistoryBtn {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 28px;
      font-weight: bold;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    #closeHistoryBtn:hover { color: #000; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      0% { transform: translate(160px, -50%) scale(0.8); opacity: 0; }
      80% { transform: translate(160px, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(160px, -50%) scale(1); opacity: 1; }
    }
    @media (max-width: 768px) {
      body { padding-bottom: 10px; }
      header { flex-direction: column; padding: 10px 5px; }
      #title {
        font-size: 22px;
        margin-bottom: 10px;
      }
      #header-buttons-container { align-items: center; }
      .button { padding: 10px 12px; font-size: 14px; }
      #start-screen, .quiz-container { width: 95%; margin: 15px auto; padding: 20px; min-height: 0; }
      #start-screen h1 { font-size: 24px; }
      #username, .input-field { width: 90%; box-sizing: border-box; font-size: 18px; }
      #question { font-size: 22px; }
      #feedback { position: static; transform: none; text-align: center; width: 100%; margin-top: 10px; font-size: 20px; }
      @keyframes popIn {
          0% { transform: scale(0.8); opacity: 0; }
          80% { transform: scale(1.1); opacity: 1; }
          100% { transform: scale(1); opacity: 1; }
      }
      #input-wrapper { min-height: 0; display: flex; flex-direction: column; align-items: center; }
      #history-container { max-height: 40%; }
    }
  </style>
</head>
<body>
  <header class="hidden">
    <div id="title">Eiken Pre-1 Vocabulary Quiz</div>
    <div id="header-buttons-container">
      <div id="top-row-buttons">
        <button class="button btn-blue" id="toggleHistoryBtn">å±¥æ­´</button>
        <button class="button btn-blue hidden" id="backToStartBtn">æœ€åˆã«æˆ»ã‚‹</button>
        <button class="button btn-blue hidden" id="retryBtn">é–“é•ãˆãŸå•é¡Œã«å†æŒ‘æˆ¦</button>
      </div>
      <div id="bottom-row-buttons">
        <button class="button btn-blue hidden" id="pdfBtn">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="button btn-blue hidden" id="wrongPdfBtn">é–“é•ãˆãŸå˜èªã‚’PDFåŒ–</button>
        <button class="button btn-blue hidden" id="downloadAllBtn">å…¨å˜èªãƒªã‚¹ãƒˆã‚’PDFåŒ–</button>
      </div>
    </div>
  </header>

  <div id="start-screen" class="animate-in">
    <h1>è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</h1>
    <p>Please enter your name to start the quiz.</p>
    <input type="text" id="username" placeholder="åå‰ã‚’å…¥åŠ›">
    <button class="button btn-green" id="startBtn" disabled>ã‚¯ã‚¤ã‚ºé–‹å§‹</button>
  </div>

  <div class="quiz-container hidden">
    <div id="question"></div>
    <div id="input-wrapper">
      <div id="inputs"></div>
      <div id="feedback"></div>
    </div>
    <button class="button btn-green" id="submitBtn">æ±ºå®š</button>
    <button class="button btn-blue hidden" id="prevBtn">å‰ã¸</button>
    <button class="button btn-green hidden" id="nextBtn">æ¬¡ã¸</button>
    <button class="button btn-blue hidden" id="showAllBtn">çµæœã‚’ã™ã¹ã¦è¡¨ç¤º</button>
    <div id="translation"></div>
    <div class="progress-bar" id="progressBar">
      <div class="progress" id="progress"></div>
    </div>
    <div id="scoreBoard"></div>
  </div>

  <div id="history-container">
    <button id="closeHistoryBtn" title="é–‰ã˜ã‚‹">&times;</button>
    <h2>ãƒ—ãƒ¬ã‚¤å±¥æ­´<button id="clearHistoryBtn" class="button btn-red">å…¨ã¦æ¶ˆå»</button></h2>
    <input type="search" id="historySearchInput" placeholder="åå‰ã‚„æ—¥ä»˜ã§å±¥æ­´ã‚’æ¤œç´¢...">
    <ul id="history-list"></ul>
  </div>

  <script>
    const allQuestions = [
  {
    "sentence": "Patients are ___ to infection just after surgery.",
    "answers": ["vulnerable"],
    "translation": "Patients are vulnerable to infection just after surgery.",
    "jpTranslation": "æ‚£è€…ã¯æ‰‹è¡“ã®ç›´å¾Œã€æ„ŸæŸ“ç—‡ã«ã‹ã‹ã‚Šã‚„ã™ããªã‚‹ã€‚",
    "blanksTranslation": ["å‚·ã¤ãã‚„ã™ã„ã€ã‹ã‹ã‚Šã‚„ã™ã„"]
  },
  {
    "sentence": "Make sure to ___ all the warning signs.",
    "answers": ["heed"],
    "translation": "Make sure to heed all the warning signs.",
    "jpTranslation": "ã™ã¹ã¦ã®è­¦æˆ’æ¨™è­˜ã«æ°—ã‚’ã¤ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚",
    "blanksTranslation": ["ã€œã«æ°—ã‚’ã¤ã‘ã‚‹ã€ã‚’å¿ƒã«ç•™ã‚ã‚‹"]
  },
  {
    "sentence": "A ___ captured the arrest on video.",
    "answers": ["bystander"],
    "translation": "A bystander captured the arrest on video.",
    "jpTranslation": "ãã®å ´ã«å±…åˆã‚ã›ãŸäººãŒé€®æ•ã®æ§˜å­ã‚’å‹•ç”»ã«åã‚ãŸã€‚",
    "blanksTranslation": ["å‚è¦³è€…ã€è¦‹ç‰©äºº"]
  },
  {
    "sentence": "The bridge eases ___ in the area.",
    "answers": ["congestion"],
    "translation": "The bridge eases congestion in the area.",
    "jpTranslation": "ãã®æ©‹ã¯åœ°åŸŸã®æ··é›‘ã‚’ç·©å’Œã—ã¦ã„ã‚‹ã€‚",
    "blanksTranslation": ["æ··é›‘"]
  },
  {
    "sentence": "She ___ all her appliances and replaced them with new ones.",
    "answers": ["discarded"],
    "translation": "She discarded all her appliances and replaced them with new ones.",
    "jpTranslation": "å½¼å¥³ã¯ã™ã¹ã¦ã®é›»åŒ–è£½å“ã‚’æ¨ã¦ã€æ–°ã—ã„ã‚‚ã®ã«è²·ã„æ›ãˆãŸã€‚",
    "blanksTranslation": ["ã€œã‚’æ¨ã¦ã‚‹ã€å‡¦åˆ†ã™ã‚‹"]
  },
  {
    "sentence": "The ___ was completely out of control and spread quickly.",
    "answers": ["blaze"],
    "translation": "The blaze was completely out of control and spread quickly.",
    "jpTranslation": "ç‚ã¯å®Œå…¨ã«åˆ¶å¾¡ä¸èƒ½ã§ã€ã‚ã£ã¨ã„ã†é–“ã«ç‡ƒãˆåºƒãŒã£ãŸã€‚",
    "blanksTranslation": ["ç‚ã€ç«ç‚"]
  },
  {
    "sentence": "He is a little ___ with a paintbrush.",
    "answers": ["clumsy"],
    "translation": "He is a little clumsy with a paintbrush.",
    "jpTranslation": "å½¼ã¯çµµç­†ã‚’ä½¿ã†ã®ãŒå°‘ã—ä¸å™¨ç”¨ã ã€‚",
    "blanksTranslation": ["ä¸å™¨ç”¨ãªã€ãã“ã¡ãªã„"]
  },
  {
    "sentence": "We must ___ major sources of pollution quickly.",
    "answers": ["eliminate"],
    "translation": "We must eliminate major sources of pollution quickly.",
    "jpTranslation": "ç§ãŸã¡ã¯ä¸»è¦ãªæ±šæŸ“æºã‚’è¿…é€Ÿã«å–ã‚Šé™¤ã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚",
    "blanksTranslation": ["ã€œã‚’å–ã‚Šé™¤ãã€å¤–ã™"]
  },
  {
    "sentence": "Stock prices ___ after the company's announcement.",
    "answers": ["soared"],
    "translation": "Stock prices soared after the company's announcement.",
    "jpTranslation": "ãã®ä¼šç¤¾ã®ç™ºè¡¨å¾Œã€æ ªä¾¡ã¯æ€¥é¨°ã—ãŸã€‚",
    "blanksTranslation": ["æ€¥ä¸Šæ˜‡ã™ã‚‹ã€èˆã„ä¸ŠãŒã‚‹"]
  },
  {
    "sentence": "The invention of the Internet had a ___ effect on our lives.",
    "answers": ["profound"],
    "translation": "The invention of the Internet had a profound effect on our lives.",
    "jpTranslation": "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã®ç™ºæ˜ã¯ç§ãŸã¡ã®ç”Ÿæ´»ã«é‡å¤§ãªå½±éŸ¿ã‚’åŠã¼ã—ãŸã€‚",
    "blanksTranslation": ["é‡å¤§ãªã€æ·±ã„"]
  },
  {
    "sentence": "She has all the right ___ for the job.",
    "answers": ["credentials"],
    "translation": "She has all the right credentials for the job.",
    "jpTranslation": "å½¼å¥³ã¯ãã®ä»•äº‹ã«ç”³ã—åˆ†ã®ãªã„çµŒæ­´ã‚’æŒã£ã¦ã„ã‚‹ã€‚",
    "blanksTranslation": ["çµŒæ­´ã€è³‡æ ¼"]
  },
  {
    "sentence": "We need to ___ our contract before we sign it.",
    "answers": ["amend"],
    "translation": "We need to amend our contract before we sign it.",
    "jpTranslation": "ç§ãŸã¡ã¯ç½²åã™ã‚‹å‰ã«å¥‘ç´„æ›¸ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚",
    "blanksTranslation": ["ã€œã‚’ä¿®æ­£ã™ã‚‹ã€æ”¹ã‚ã‚‹"]
  },
  {
    "sentence": "The politician's speech ___ the crowd.",
    "answers": ["agitated"],
    "translation": "The politician's speech agitated the crowd.",
    "jpTranslation": "ãã®æ”¿æ²»å®¶ã®æ¼”èª¬ã¯ç¾¤è¡†ã‚’æ‰‡å‹•ã—ãŸã€‚",
    "blanksTranslation": ["ã€œã‚’æ‰‡å‹•ã™ã‚‹ã€å‹•æºã•ã›ã‚‹"]
  },
  {
    "sentence": "Please be ___ when you talk to him about the matter.",
    "answers": ["discreet"],
    "translation": "Please be discreet when you talk to him about the matter.",
    "jpTranslation": "ãã®ä»¶ã§å½¼ã¨è©±ã™ã¨ãã¯ã€ãã‚Œãã‚Œã‚‚æ…é‡ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚",
    "blanksTranslation": ["åˆ†åˆ¥ã®ã‚ã‚‹ã€æ€æ…®æ·±ã„"]
  },
  {
    "sentence": "She ___ the house at one million dollars.",
    "answers": ["appraised"],
    "translation": "She appraised the house at one million dollars.",
    "jpTranslation": "å½¼å¥³ã¯ãã®å®¶ã‚’100ä¸‡ãƒ‰ãƒ«ã¨æŸ»å®šã—ãŸã€‚",
    "blanksTranslation": ["ã€œã‚’è©•ä¾¡ã™ã‚‹ã€é‘‘å®šã™ã‚‹"]
  },
  {
    "sentence": "Rice is a ___ food in many Asian countries.",
    "answers": ["staple"],
    "translation": "Rice is a staple food in many Asian countries.",
    "jpTranslation": "ç±³ã¯å¤šãã®ã‚¢ã‚¸ã‚¢ã®å›½ã§ä¸»é£Ÿã¨ãªã£ã¦ã„ã‚‹ã€‚",
    "blanksTranslation": ["å¿…éœ€é£Ÿå“ã€ä¸»è¦ç”£ç‰©"]
  },
  {
    "sentence": "These shoes are very ___ and will last a long time.",
    "answers": ["durable"],
    "translation": "These shoes are very durable and will last a long time.",
    "jpTranslation": "ã“ã®é´ã¯ã¨ã¦ã‚‚ä¸ˆå¤«ã§é•·æŒã¡ã™ã‚‹ã ã‚ã†ã€‚",
    "blanksTranslation": ["è€ä¹…æ€§ã®ã‚ã‚‹ã€ä¸ˆå¤«ãª"]
  },
  {
    "sentence": "He ordered a ___ from the menu.",
    "answers": ["beverage"],
    "translation": "He ordered a beverage from the menu.",
    "jpTranslation": "å½¼ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰é£²ã¿ç‰©ã‚’æ³¨æ–‡ã—ãŸã€‚",
    "blanksTranslation": ["é£²ã¿ç‰©ã€é£²æ–™"]
  },
  {
    "sentence": "The government ___ funds for the new project.",
    "answers": ["allocated"],
    "translation": "The government allocated funds for the new project.",
    "jpTranslation": "æ”¿åºœã¯æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è³‡é‡‘ã‚’å‰²ã‚Šå½“ã¦ãŸã€‚",
    "blanksTranslation": ["ã€œã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€åˆ†é…ã™ã‚‹"]
  },
  {
    "sentence": "She is a ___ expert in her field.",
    "answers": ["renowned"],
    "translation": "She is a renowned expert in her field.",
    "jpTranslation": "å½¼å¥³ã¯è‡ªåˆ†ã®åˆ†é‡ã§æœ‰åãªå°‚é–€å®¶ã ã€‚",
    "blanksTranslation": ["åé«˜ã„ã€è‘—åãª"]
  },
  {
    "sentence": "Please place the ___ on the table.",
    "answers": ["utensils"],
    "translation": "Please place the utensils on the table.",
    "jpTranslation": "é£Ÿå“ã«é£Ÿå™¨ã‚’ä¸¦ã¹ã¦ãã ã•ã„ã€‚",
    "blanksTranslation": ["èª¿ç†å™¨å…·ã€å®¶åº­ç”¨å“"]
  },
  {
    "sentence": "He is a ___ and healthy man.",
    "answers": ["robust"],
    "translation": "He is a robust and healthy man.",
    "jpTranslation": "å½¼ã¯ãŸãã¾ã—ãã¦å¥åº·ãªç”·æ€§ã ã€‚",
    "blanksTranslation": ["ä¸ˆå¤«ãªã€ãŒã£ã—ã‚Šã—ãŸ"]
  },
  {
    "sentence": "The painting ___ a beautiful landscape.",
    "answers": ["depicts"],
    "translation": "The painting depicts a beautiful landscape.",
    "jpTranslation": "ãã®çµµç”»ã¯ç¾ã—ã„é¢¨æ™¯ã‚’æå†™ã—ã¦ã„ã‚‹ã€‚",
    "blanksTranslation": ["ã€œã‚’æå†™ã™ã‚‹ã€æã"]
  },
  {
    "sentence": "Please ___ the payment by the due date.",
    "answers": ["remit"],
    "translation": "Please remit the payment by the due date.",
    "jpTranslation": "æœŸæ—¥ã¾ã§ã«æ”¯æ‰•ã„ã‚’ã”é€é‡‘ãã ã•ã„ã€‚",
    "blanksTranslation": ["ã€œã‚’é€é‡‘ã™ã‚‹ã€é€ã‚‹"]
  },
  {
    "sentence": "The food will ___ if you leave it out of the refrigerator.",
    "answers": ["perish"],
    "translation": "The food will perish if you leave it out of the refrigerator.",
    "jpTranslation": "å†·è”µåº«ã‹ã‚‰å‡ºã—ã¦ãŠãã¨ã€é£Ÿã¹ç‰©ã¯è…ã£ã¦ã—ã¾ã„ã¾ã™ã€‚",
    "blanksTranslation": ["è…ã‚‹ã€æ»…ã³ã‚‹"]
  },
  {
    "sentence": "Please ___ to the rules of the game.",
    "answers": ["adhere"],
    "translation": "Please adhere to the rules of the game.",
    "jpTranslation": "ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ãã ã•ã„ã€‚",
    "blanksTranslation": ["ã€œã‚’é †å®ˆã™ã‚‹ã€ã«ãã£ã¤ã"]
  },
  {
    "sentence": "The roads are always ___ during rush hour.",
    "answers": ["congested"],
    "translation": "The roads are always congested during rush hour.",
    "jpTranslation": "ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ¯ãƒ¼ã®é–“ã€é“è·¯ã¯ã„ã¤ã‚‚æ··é›‘ã—ã¦ã„ã‚‹ã€‚",
    "blanksTranslation": ["æ··é›‘ã—ãŸã€è©°ã¾ã£ãŸ"]
  },
  {
    "sentence": "The ___ company developed a new drug.",
    "answers": ["pharmaceutical"],
    "translation": "The pharmaceutical company developed a new drug.",
    "jpTranslation": "ãã®è£½è–¬ä¼šç¤¾ã¯æ–°è–¬ã‚’é–‹ç™ºã—ãŸã€‚",
    "blanksTranslation": ["è£½è–¬ã®ã€èª¿å‰¤ã®"]
  },
  {
    "sentence": "The company will ___ you for your travel expenses.",
    "answers": ["reimburse"],
    "translation": "The company will reimburse you for your travel expenses.",
    "jpTranslation": "ä¼šç¤¾ã¯ã‚ãªãŸã®æ—…è²»ã‚’æ‰•ã„æˆ»ã—ã¾ã™ã€‚",
    "blanksTranslation": ["ã€œã‚’æ‰•ã„æˆ»ã™ã€è¿”æ¸ˆã™ã‚‹"]
  },
  {
    "sentence": "I can't ___ this product because I don't believe in it.",
    "answers": ["endorse"],
    "translation": "I can't endorse this product because I don't believe in it.",
    "jpTranslation": "ç§ã¯ã“ã®è£½å“ã‚’ä¿¡ã˜ã¦ã„ãªã„ã®ã§ã€æ¨è–¦ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚",
    "blanksTranslation": ["ã€œã‚’æ¨è–¦ã™ã‚‹ã€æ”¯æŒã™ã‚‹"]
  },
  {
    "sentence": "The sound of the rain was very ___.",
    "answers": ["soothing"],
    "translation": "The sound of the rain was very soothing.",
    "jpTranslation": "é›¨ã®éŸ³ã¯ã¨ã¦ã‚‚å¿ƒåœ°ã‚ˆã‹ã£ãŸã€‚",
    "blanksTranslation": ["å¿ƒåœ°ã‚ˆã„ã€ãªã ã‚ã‚‹ã‚ˆã†ãª"]
  },
  {
    "sentence": "The plane went through a ___ patch of air.",
    "answers": ["turbulent"],
    "translation": "The plane went through a turbulent patch of air.",
    "jpTranslation": "é£›è¡Œæ©Ÿã¯ä¹±æ°—æµã®é ˜åŸŸã‚’é€šéã—ãŸã€‚",
    "blanksTranslation": ["æ¿€å‹•ã®ã€è’ã‚Œç‹‚ã†"]
  },
  {
    "sentence": "The book is a ___ of the author's life.",
    "answers": ["chronicle"],
    "translation": "The book is a chronicle of the author's life.",
    "jpTranslation": "ãã®æœ¬ã¯è‘—è€…ã®äººç”Ÿã®è¨˜éŒ²ã ã€‚",
    "blanksTranslation": ["å¹´ä»£è¨˜ã€è¨˜éŒ²"]
  },
  {
    "sentence": "Please ___ your report to one page.",
    "answers": ["condense"],
    "translation": "Please condense your report to one page.",
    "jpTranslation": "å ±å‘Šæ›¸ã‚’1ãƒšãƒ¼ã‚¸ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚",
    "blanksTranslation": ["ã€œã‚’å‡ç¸®ã™ã‚‹ã€è¦ç´„ã™ã‚‹"]
  },
  {
    "sentence": "The package arrived ___, despite the long journey.",
    "answers": ["intact"],
    "translation": "The package arrived intact, despite the long journey.",
    "jpTranslation": "é•·ã„æ—…ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€è·ç‰©ã¯ç„¡å‚·ã§å±Šã„ãŸã€‚",
    "blanksTranslation": ["ç„¡å‚·ã®ã€æãªã‚ã‚Œã¦ã„ãªã„"]
  },
  {
    "sentence": "The ___ caused a shortage of water in the region.",
    "answers": ["drought"],
    "translation": "The drought caused a shortage of water in the region.",
    "jpTranslation": "å¹²ã°ã¤ã¯ãã®åœ°åŸŸã§æ°´ä¸è¶³ã‚’å¼•ãèµ·ã“ã—ãŸã€‚",
    "blanksTranslation": ["å¹²ã°ã¤ã€æ—¥ç…§ã‚Šç¶šã"]
  },
  {
    "sentence": "He has a very ___ business.",
    "answers": ["lucrative"],
    "translation": "He has a very lucrative business.",
    "jpTranslation": "å½¼ã¯ã¨ã¦ã‚‚å„²ã‹ã‚‹ãƒ“ã‚¸ãƒã‚¹ã‚’ã—ã¦ã„ã‚‹ã€‚",
    "blanksTranslation": ["å„²ã‹ã‚‹ã€æœ‰åˆ©ãª"]
  },
  {
    "sentence": "The ___ of the students' scores was very high.",
    "answers": ["aggregate"],
    "translation": "The aggregate of the students' scores was very high.",
    "jpTranslation": "ç”Ÿå¾’ãŸã¡ã®åˆè¨ˆç‚¹ã¯éå¸¸ã«é«˜ã‹ã£ãŸã€‚",
    "blanksTranslation": ["ç·è¨ˆã€é›†åˆä½“"]
  },
  {
    "sentence": "This software is not ___ with your computer.",
    "answers": ["compatible"],
    "translation": "This software is not compatible with your computer.",
    "jpTranslation": "ã“ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ã‚ãªãŸã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã¨äº’æ›æ€§ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
    "blanksTranslation": ["äº’æ›æ€§ã®ã‚ã‚‹ã€ä¸¡ç«‹ã§ãã‚‹"]
  },
  {
    "sentence": "The celebrity's ___ helped to sell the product.",
    "answers": ["endorsement"],
    "translation": "The celebrity's endorsement helped to sell the product.",
    "jpTranslation": "ãã®æœ‰åäººã®æ¨è–¦ã¯ã€è£½å“ã®è²©å£²ã«å½¹ç«‹ã£ãŸã€‚",
    "blanksTranslation": ["æ¨è–¦ã€æ”¯æŒ"]
  },
  {
    "sentence": "You can save money by buying ___ drugs.",
    "answers": ["generic"],
    "translation": "You can save money by buying generic drugs.",
    "jpTranslation": "ã‚¸ã‚§ãƒãƒªãƒƒã‚¯åŒ»è–¬å“ã‚’è²·ã†ã“ã¨ã§ãŠé‡‘ã‚’ç¯€ç´„ã§ãã‚‹ã€‚",
    "blanksTranslation": ["ä¸€èˆ¬çš„ãªã€ãƒ–ãƒ©ãƒ³ãƒ‰åã®ãªã„"]
  },
  {
    "sentence": "There is a ___ fee for using the service.",
    "answers": ["nominal"],
    "translation": "There is a nominal fee for using the service.",
    "jpTranslation": "ãã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã»ã‚“ã®ã‚ãšã‹ãªæ‰‹æ•°æ–™ãŒã‹ã‹ã‚‹ã€‚",
    "blanksTranslation": ["ã»ã‚“ã®ã‚ãšã‹ã®ã€åç›®ä¸Šã®"]
  },
  {
    "sentence": "There is a ___ between the two reports.",
    "answers": ["discrepancy"],
    "translation": "There is a discrepancy between the two reports.",
    "jpTranslation": "2ã¤ã®å ±å‘Šæ›¸ã«ã¯é£Ÿã„é•ã„ãŒã‚ã‚‹ã€‚",
    "blanksTranslation": ["é£Ÿã„é•ã„ã€ä¸ä¸€è‡´"]
  },
  {
    "sentence": "You are ___ for any damage you cause.",
    "answers": ["liable"],
    "translation": "You are liable for any damage you cause.",
    "jpTranslation": "ã‚ãªãŸãŒå¼•ãèµ·ã“ã—ãŸæå®³ã«ã¤ã„ã¦ã¯ã€ã‚ãªãŸã«è²¬ä»»ãŒã‚ã‚Šã¾ã™ã€‚",
    "blanksTranslation": ["è²¬ä»»ãŒã‚ã‚‹ã€ã€œã—ãŒã¡ãª"]
  },
  {
    "sentence": "The training program is very ___.",
    "answers": ["rigorous"],
    "translation": "The training program is very rigorous.",
    "jpTranslation": "ãã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯éå¸¸ã«å³ã—ã„ã€‚",
    "blanksTranslation": ["å³æ ¼ãªã€å³ã—ã„"]
  },
  {
    "sentence": "He won the championship for the third ___ year.",
    "answers": ["consecutive"],
    "translation": "He won the championship for the third consecutive year.",
    "jpTranslation": "å½¼ã¯3å¹´é€£ç¶šã§é¸æ‰‹æ¨©ã«å„ªå‹ã—ãŸã€‚",
    "blanksTranslation": ["é€£ç¶šã—ãŸ"]
  },
  {
    "sentence": "The company agreed to ___ the fee.",
    "answers": ["waive"],
    "translation": "The company agreed to waive the fee.",
    "jpTranslation": "ä¼šç¤¾ã¯ãã®æ–™é‡‘ã‚’å…é™¤ã™ã‚‹ã“ã¨ã«åŒæ„ã—ãŸã€‚",
    "blanksTranslation": ["ã€œã‚’æ”¾æ£„ã™ã‚‹ã€å·®ã—æ§ãˆã‚‹"]
  },
  {
    "sentence": "There was a ___ in demand for the new product.",
    "answers": ["surge"],
    "translation": "There was a surge in demand for the new product.",
    "jpTranslation": "æ–°è£½å“ã¸ã®éœ€è¦ãŒæ€¥å¢—ã—ãŸã€‚",
    "blanksTranslation": ["æ€¥å¢—ã€æ®ºåˆ°"]
  },
  {
    "sentence": "He used his house as ___ for the loan.",
    "answers": ["collateral"],
    "translation": "He used his house as collateral for the loan.",
    "jpTranslation": "å½¼ã¯ãã®ãƒ­ãƒ¼ãƒ³ã«å®¶ã‚’æ‹…ä¿ã¨ã—ã¦å·®ã—å‡ºã—ãŸã€‚",
    "blanksTranslation": ["æ‹…ä¿ã€ä¿è¨¼ç‰©ä»¶"]
  }
];

    const CORRECT_PASSWORD = '1234';

    let playerName = '';
    let questions = [];
    let current = 0, score = 0;
    let lastAnsweredIndex = -1;
    let userAnswers = [], incorrectQuestions = [], retryMode = false, wrongAnswers = [];
    let keyupLock = false;
    let titleClickCount = 0;
    let titleClickTimer = null;
    let englishVoices = [];

    const header = document.querySelector("header");
    const startScreen = document.getElementById("start-screen");
    const startBtn = document.getElementById("startBtn");
    const usernameInput = document.getElementById("username");
    const quizContainer = document.querySelector(".quiz-container");
    const mainTitle = document.getElementById("title");
    const startScreenTitle = document.querySelector("#start-screen h1");
    const qEl = document.getElementById("question");
    const inputEl = document.getElementById("inputs");
    const feedbackEl = document.getElementById("feedback");
    const translationEl = document.getElementById("translation");
    const scoreBoard = document.getElementById("scoreBoard");
    const pdfBtn = document.getElementById("pdfBtn");
    const wrongPdfBtn = document.getElementById("wrongPdfBtn");
    const retryBtn = document.getElementById("retryBtn");
    const showAllBtn = document.getElementById("showAllBtn");
    const submitBtn = document.getElementById("submitBtn");
    const nextBtn = document.getElementById("nextBtn");
    const progressBar = document.getElementById("progressBar");
    const progressEl = document.getElementById("progress");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const backToStartBtn = document.getElementById("backToStartBtn");
    const prevBtn = document.getElementById("prevBtn");
    const toggleHistoryBtn = document.getElementById("toggleHistoryBtn");
    const historyContainer = document.getElementById("history-container");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");
    const historySearchInput = document.getElementById("historySearchInput");
    const closeHistoryBtn = document.getElementById("closeHistoryBtn");

    function loadQuestion() {
      quizContainer.classList.remove('animate-in');
      void quizContainer.offsetWidth;
      quizContainer.classList.add('animate-in');
      retryBtn.classList.add("hidden");
      prevBtn.classList.add("hidden");
      nextBtn.classList.add("hidden");
      showAllBtn.classList.add("hidden");
      qEl.style.marginBottom = "";
      translationEl.style.marginTop = "";
      const q = questions[current];
      qEl.innerHTML = `<div>Q${current + 1} / ${questions.length}: ${q.sentence}</div><div class="jp-translation">${q.jpTranslation}</div>`;
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      feedbackEl.classList.remove('feedback-animate');
      translationEl.textContent = "";
      q.answers.forEach((_, i) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "input-field";
        inp.id = "ans" + i;
        inputEl.appendChild(inp);
      });
      const inputs = document.querySelectorAll(".input-field");
      inputs[0].focus();
      inputs.forEach((inp, idx) => {
        inp.addEventListener("keydown", e => {
          if (e.key === "Enter") {
            e.preventDefault();
            if (idx < inputs.length - 1) {
              inputs[idx + 1].focus();
            } else {
              keyupLock = true;
              checkAnswer();
            }
          }
        });
      });
      if (userAnswers[current]) {
        inputs.forEach((inp, i) => {
          inp.value = userAnswers[current].user[i] || "";
        });
      }
      submitBtn.classList.remove("hidden");
      const progressPercentage = (questions.length > 1) ? Math.round((current / (questions.length - 1)) * 100) : 0;
      progressEl.style.width = `${progressPercentage}%`;
    }

    function recalculateScore() {
      score = userAnswers.filter(answer => {
        if (!answer) return false;
        const q = allQuestions.find(q => q.sentence === answer.question);
        if (!q) return false;
        return answer.user.every((userAns, i) => (userAns || "").toLowerCase() === (q.answers[i] || "").toLowerCase());
      }).length;
    }

    function checkAnswer() {
      const q = questions[current];
      let correct = true, answersGiven = [];
      q.answers.forEach((ans, i) => {
        const userAns = document.getElementById("ans" + i).value.trim();
        answersGiven.push(userAns);
        if (userAns.toLowerCase() !== ans.toLowerCase()) correct = false;
      });
      userAnswers[current] = { question: q.sentence, user: answersGiven };
      if (!retryMode) {
        recalculateScore();
      }
      if (!correct) {
        if (!incorrectQuestions.some(item => item.sentence === q.sentence)) incorrectQuestions.push(q);
        if (!wrongAnswers.some(item => item.sentence === q.sentence)) wrongAnswers.push(q);
      } else {
        incorrectQuestions = incorrectQuestions.filter(item => item.sentence !== q.sentence);
        wrongAnswers = wrongAnswers.filter(item => item.sentence !== q.sentence);
      }
      lastAnsweredIndex = Math.max(lastAnsweredIndex, current);
      displayAnsweredQuestion(current);
    }

    function loadNextNewQuestion() {
      current++;
      loadQuestion();
    }

    function displayAnsweredQuestion(index) {
      current = index;
      const q = questions[index];
      const recordedEntry = userAnswers[index];
      qEl.innerHTML = `<div>Q${current + 1} / ${questions.length}: ${q.sentence}</div><div class="jp-translation">${q.jpTranslation}</div>`;
      inputEl.innerHTML = "";
      q.answers.forEach((_, i) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "input-field";
        inp.id = "ans" + i;
        inputEl.appendChild(inp);
      });
      const inputs = inputEl.querySelectorAll(".input-field");
      inputs.forEach((inp, i) => {
        inp.value = recordedEntry.user[i] || "";
        inp.disabled = true;
        const wasThisPartCorrect = (recordedEntry.user[i] || "").toLowerCase() === (q.answers[i] || "").toLowerCase();
        inp.style.borderColor = wasThisPartCorrect ? 'var(--duo-green)' : 'var(--duo-red)';
        inp.style.borderWidth = '2px';
      });
      submitBtn.classList.add("hidden");
      const userWasCorrect = recordedEntry.user.every((ans, i) => (ans || "").toLowerCase() === (q.answers[i] || "").toLowerCase());
      feedbackEl.className = "feedback-animate";
      feedbackEl.textContent = userWasCorrect ? "âœ… æ­£è§£ï¼" : "âŒ ä¸æ­£è§£";
      feedbackEl.classList.add(userWasCorrect ? "correct" : "incorrect");
      let highlighted = q.translation;
      q.answers.forEach(ans => {
        highlighted = highlighted.replace(new RegExp(`\\b${ans}\\b`, "gi"), `<span style="font-weight: 900; color: red;">${ans}</span>`);
      });
      translationEl.innerHTML = `
        <p><b>è‹±æ–‡:</b> ${highlighted} <button class="button circle-button btn-green" onclick="speak('${q.translation.replace(/"/g, '')}')">ğŸ”Š</button></p>
        <p><b>ç­”ãˆ:</b> ${q.answers.join(", ")} ${q.answers.map(ans => `<button class="button circle-button btn-green" onclick="speak('${ans}')">ğŸ”Š</button>`).join(" ")}</p>
        <p><b>æ—¥æœ¬èªè¨³:</b> ${q.blanksTranslation.join(", ")}</p>
      `;
      const isLastQuestion = index === questions.length - 1;
      prevBtn.classList.toggle("hidden", index <= 0);
      showAllBtn.classList.toggle("hidden", !(isLastQuestion && current === lastAnsweredIndex));
      nextBtn.classList.toggle("hidden", isLastQuestion);
    }

    function goToPreviousQuestion() {
      if (current > 0) {
        current--;
        loadQuestion();
      }
    }

    function handleNextClick() {
      if (current < lastAnsweredIndex) {
        displayAnsweredQuestion(current + 1);
      } else {
        loadNextNewQuestion();
      }
    }

    function showAllResults() {
      progressBar.classList.add("hidden");
      recalculateScore();
      const finalScoreText = retryMode ? `${score} / ${questions.length}` : `${score} / ${allQuestions.length}`;
      savePlayHistory(playerName, finalScoreText);
      displayPlayHistory();
      scoreBoard.textContent = `ã‚¹ã‚³ã‚¢: ${finalScoreText}`;
      qEl.textContent = "å…¨çµæœ";
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      translationEl.innerHTML = "";
      qEl.style.marginBottom = "0";
      translationEl.style.marginTop = "5px";
      translationEl.innerHTML = `<p style="margin: 0;"><b>åå‰:</b> ${playerName}</p><p><b>ã‚¹ã‚³ã‚¢:</b> ${finalScoreText}</p>`;
      userAnswers.forEach((entry, idx) => {
        if (!entry) return;
        const originalQuestion = allQuestions.find(q => q.sentence === entry.question);
        if (!originalQuestion) return;
        let highlightedSentence = originalQuestion.translation;
        originalQuestion.answers.forEach(ans => {
          highlightedSentence = highlightedSentence.replace(new RegExp(`\\b(${ans})\\b`, 'gi'), `<span style="font-weight: 900; color: red;">$1</span>`);
        });
        const userAnswersGiven = entry.user.join(", ");
        const isAnswerCorrect = entry.user.every((ans, i) => (ans || "").toLowerCase() === (originalQuestion.answers[i] || "").toLowerCase());
        let yourAnswerHTML = isAnswerCorrect ? `<p style="margin: 5px 0;"><b>ã‚ãªãŸã®å›ç­”:</b> ${userAnswersGiven} <span style="color: var(--duo-green);">âœ…</span></p>` : `<p style="margin: 5px 0;"><b>ã‚ãªãŸã®å›ç­”:</b> <span style="color: var(--duo-red);">${userAnswersGiven || "(ç„¡å›ç­”)"}</span> âŒ</p>`;
        const div = document.createElement("div");
        div.style.cssText = "text-align: left; margin: 15px 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;";
        div.innerHTML = `<p style="margin: 5px 0;"><b>Q${idx + 1}:</b> ${highlightedSentence}</p><p style="margin: 5px 0; color: #555; font-size: 14px;"><b>å’Œè¨³:</b> ${originalQuestion.jpTranslation}</p>${yourAnswerHTML}`;
        translationEl.appendChild(div);
      });
      pdfBtn.classList.remove("hidden");
      backToStartBtn.classList.remove("hidden");
      if (wrongAnswers.length > 0) wrongPdfBtn.classList.remove("hidden");
      if (incorrectQuestions.length > 0) {
        retryBtn.textContent = `é–“é•ãˆãŸ ${incorrectQuestions.length} å•ã«å†æŒ‘æˆ¦`;
        retryBtn.classList.remove("hidden");
      } else {
        retryBtn.classList.add("hidden");
      }
      showAllBtn.classList.add("hidden");
      nextBtn.classList.add("hidden");
      prevBtn.classList.add("hidden");
    }

    function savePlayHistory(name, scoreText) {
      const date = new Date();
      const formattedDate = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
      const newRecord = { name, score: scoreText, date: formattedDate, results: JSON.parse(JSON.stringify(userAnswers)) };
      const history = JSON.parse(localStorage.getItem('quizPlayHistory')) || [];
      history.unshift(newRecord);
      localStorage.setItem('quizPlayHistory', JSON.stringify(history));
    }

    function displayPlayHistory(searchTerm = '') {
      let history = JSON.parse(localStorage.getItem('quizPlayHistory')) || [];
      const historyList = document.getElementById('history-list');
      const lowerCaseSearchTerm = searchTerm.toLowerCase();
      if (lowerCaseSearchTerm) {
        history = history.filter(record => `[${record.date}] ${record.name} - ã‚¹ã‚³ã‚¢: ${record.score}`.toLowerCase().includes(lowerCaseSearchTerm));
      }
      historyList.innerHTML = '';
      history.forEach(record => {
        const listItem = document.createElement('li');
        listItem.textContent = `[${record.date}] ${record.name} - ã‚¹ã‚³ã‚¢: ${record.score}`;
        listItem.title = 'ã“ã®çµæœã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
        listItem.addEventListener('click', () => downloadHistoryPDF(record));
        historyList.appendChild(listItem);
      });
    }

    function initQuiz() {
      lastAnsweredIndex = -1;
      score = 0;
      userAnswers = [];
      incorrectQuestions = [];
      wrongAnswers = [];
      questions = [...allQuestions];
      loadProgress();
      shuffle(questions);
      current = 0;
      loadQuestion();
    }

    function restartQuiz() {
      window.location.reload();
    }

    function retryIncorrect() {
      if (incorrectQuestions.length === 0) return;
      lastAnsweredIndex = -1;
      score = 0;
      userAnswers = [];
      wrongAnswers = [];
      questions = [...incorrectQuestions];
      incorrectQuestions = [];
      retryMode = true;
      scoreBoard.textContent = "";
      progressBar.classList.remove("hidden");
      pdfBtn.classList.add("hidden");
      wrongPdfBtn.classList.add("hidden");
      retryBtn.classList.add("hidden");
      backToStartBtn.classList.add("hidden");
      quizContainer.classList.remove("hidden");
      header.classList.remove("hidden");
      current = 0;
      loadQuestion();
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function saveProgress() {
      localStorage.setItem('eikenQuizIncorrect', JSON.stringify(incorrectQuestions.map(q => q.sentence)));
    }

    function loadProgress() {
      try {
        const savedIncorrect = localStorage.getItem('eikenQuizIncorrect');
        if (savedIncorrect) {
          const incorrectSentences = JSON.parse(savedIncorrect);
          if (Array.isArray(incorrectSentences)) {
            const loadedIncorrect = allQuestions.filter(q => incorrectSentences.includes(q.sentence));
            if (loadedIncorrect.length > 0) {
              incorrectQuestions = loadedIncorrect;
              retryBtn.textContent = `é–“é•ãˆãŸ ${incorrectQuestions.length} å•ã«å†æŒ‘æˆ¦`;
              retryBtn.classList.remove("hidden");
            }
          }
        }
      } catch (e) {
        console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        localStorage.removeItem('eikenQuizIncorrect');
      }
    }

    function loadVoices() {
      englishVoices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en-'));
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    /* â–¼â–¼â–¼ [å¤‰æ›´] éŸ³å£°å†ç”ŸãŒé€”åˆ‡ã‚Œã‚‹ãƒã‚°ã‚’ä¿®æ­£ â–¼â–¼â–¼ */
    function speak(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      // A short timeout helps prevent a race condition bug in some browsers (like Chrome)
      // where cancel() also cancels the new utterance if called too closely together.
      setTimeout(() => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "en-US";
        if (englishVoices.length > 0) {
          let selectedVoice = englishVoices.find(v => v.lang === "en-US" && v.name.includes("Female")) ||
                              englishVoices.find(v => v.lang === "en-US") ||
                              englishVoices[0];
          u.voice = selectedVoice;
        }
        speechSynthesis.speak(u);
      }, 50);
    }
    /* â–²â–²â–² â–²â–²â–² */

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let usernameForPdf = wanakana.isJapanese(playerName) ? wanakana.toRomaji(playerName) : playerName;
      const finalScoreText = retryMode ? `${score} / ${questions.length}` : `${score} / ${allQuestions.length}`;
      doc.setFontSize(14);
      doc.text("Quiz Results", 10, 10);
      if (usernameForPdf) doc.text(`Name: ${usernameForPdf}`, 10, 20);
      doc.text(`Score: ${finalScoreText}`, 10, 30);
      let y = 40;
      userAnswers.forEach((entry, idx) => {
        if (!entry) return;
        const originalQuestion = allQuestions.find(q => q.sentence === entry.question);
        if(!originalQuestion) return;
        
        const linesQ = doc.splitTextToSize(`Q${idx + 1}: ${originalQuestion.sentence}`, 180);
        doc.text(linesQ, 10, y); y += linesQ.length * 7;
        const linesU = doc.splitTextToSize(`Your Answer: ${entry.user.join(", ")}`, 180);
        doc.text(linesU, 10, y); y += linesU.length * 7;
        const linesC = doc.splitTextToSize(`Correct Answer: ${originalQuestion.answers.join(", ")}`, 180);
        doc.text(linesC, 10, y); y += linesC.length * 7 + 5;
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save("quiz_results.pdf");
    }

    function downloadWrongPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Wrong Vocabulary Results", 10, 10);
      let y = 20;
      wrongAnswers.forEach((q, idx) => {
        const linesQ = doc.splitTextToSize(`${idx + 1}. ${q.sentence}`, 180);
        doc.text(linesQ, 10, y); y += linesQ.length * 8;
        const linesA = doc.splitTextToSize(`Answer: ${q.answers.join(", ")}`, 180);
        doc.text(linesA, 10, y); y += linesA.length * 8 + 5;
        if (y > 270) { doc.addPage(); y = 20; }
      });
      doc.save("Wrong-vocab.pdf");
    }

    function downloadHistoryPDF(historyRecord) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let usernameForPdf = wanakana.isJapanese(historyRecord.name) ? wanakana.toRomaji(historyRecord.name) : historyRecord.name;
      doc.setFontSize(16);
      doc.text("Quiz Results", 105, 15, null, null, "center");
      doc.setFontSize(12);
      doc.text(`Name: ${usernameForPdf}`, 10, 25);
      doc.text(`Score: ${historyRecord.score}`, 10, 32);
      doc.text(`Date: ${historyRecord.date}`, 10, 39);
      let y = 50;
      historyRecord.results.forEach((entry, idx) => {
        if (!entry) return;
        const originalQuestion = allQuestions.find(q => q.sentence === entry.question);
        if(!originalQuestion) return;

        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        const isCorrect = entry.user.every((ans, i) => (ans || "").toLowerCase() === (originalQuestion.answers[i] || "").toLowerCase());
        doc.setFontSize(12);
        doc.text(`Q${idx + 1}: ${originalQuestion.sentence}`, 10, y); y += 7;
        doc.setFontSize(10);
        doc.setTextColor(isCorrect ? '#28a745' : '#dc3545');
        doc.text(`Your Answer: ${entry.user.join(", ") || "(no answer)"}`, 15, y); y += 7;
        if (!isCorrect) {
          doc.setTextColor('#333333');
          doc.text(`Correct Answer: ${originalQuestion.answers.join(", ")}`, 15, y); y += 7;
        }
        y += 5;
      });
      const datePart = historyRecord.date.replace(/[/:\s]/g, '-');
      const namePart = usernameForPdf.replace(/\s/g, '_');
      doc.save(`${datePart}-${namePart}.pdf`);
    }

    function downloadAllQuestionsPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Eiken Pre-1 Vocabulary List", 10, 15);
      let y = 25;
      doc.setFontSize(12);
      allQuestions.forEach((q, idx) => {
        if (y > 270) { doc.addPage(); y = 20; }
        const questionText = `${idx + 1}. ${q.sentence.replace('___', `[ ${q.answers[0]} ]`)}`;
        const linesQ = doc.splitTextToSize(questionText, 180);
        doc.text(linesQ, 10, y);
        y += linesQ.length * 7 + 5;
      });
      doc.save("Eiken-Pre-1-Vocab-List.pdf");
    }
    
    // --- Event Listeners ---
    pdfBtn.onclick = downloadPDF;
    wrongPdfBtn.onclick = downloadWrongPDF;
    submitBtn.onclick = checkAnswer;
    nextBtn.onclick = handleNextClick;
    prevBtn.onclick = goToPreviousQuestion;
    showAllBtn.onclick = showAllResults;
    retryBtn.onclick = retryIncorrect;
    downloadAllBtn.onclick = downloadAllQuestionsPDF;
    backToStartBtn.onclick = restartQuiz;

    toggleHistoryBtn.addEventListener('click', () => {
      if (historyContainer.classList.contains('show')) {
        historyContainer.classList.remove('show');
      } else {
        const inputPassword = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (inputPassword === null) return;
        if (inputPassword === CORRECT_PASSWORD) {
          historyContainer.classList.add('show');
        } else {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
        }
      }
    });

    closeHistoryBtn.onclick = () => {
      historyContainer.classList.remove('show');
    };

    clearHistoryBtn.addEventListener('click', () => {
      const inputPassword = prompt('å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (inputPassword === null) return;
      if (inputPassword === CORRECT_PASSWORD) {
        if (confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã™ã¹ã¦ã®å±¥æ­´ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
          localStorage.removeItem('quizPlayHistory');
          historySearchInput.value = '';
          displayPlayHistory();
          alert('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        }
      } else {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
      }
    });

    function secretClickHandler() {
      titleClickCount++;
      clearTimeout(titleClickTimer);
      titleClickTimer = setTimeout(() => {
        titleClickCount = 0;
      }, 1500);
      if (titleClickCount >= 5) {
        titleClickCount = 0;
        clearTimeout(titleClickTimer);
        toggleHistoryBtn.click();
      }
    }

    mainTitle.addEventListener('click', secretClickHandler);
    startScreenTitle.addEventListener('click', secretClickHandler);

    document.addEventListener('keyup', (event) => {
      if (event.key !== 'Enter') return;
      if (keyupLock) {
        keyupLock = false;
        return;
      }
      if (document.activeElement && document.activeElement.tagName === 'INPUT') {
        return;
      }
      if (!nextBtn.classList.contains('hidden')) {
        handleNextClick();
      } else if (!showAllBtn.classList.contains('hidden')) {
        showAllResults();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      displayPlayHistory();
    });

    usernameInput.addEventListener('input', () => {
      startBtn.disabled = usernameInput.value.trim() === '';
    });

    startBtn.addEventListener('click', () => {
      playerName = usernameInput.value.trim();
      startScreen.classList.remove('animate-in');
      startScreen.classList.add('hidden');
      quizContainer.classList.remove('hidden');
      header.classList.remove('hidden');
      initQuiz();
    });

    usernameInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        if (!startBtn.disabled) {
          event.preventDefault();
          startBtn.click();
        }
      }
    });

    historySearchInput.addEventListener('input', () => {
      displayPlayHistory(historySearchInput.value);
    });
  </script>
</body>
</html>
